<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Solicita√ß√£o de Compras</title>
    <style>
      :root {
        --primary-color: #0854a0;
        --primary-hover: #0a4d8c;
        --secondary-color: #f0f3f6;
        --border-color: #d4d4d4;
        --text-color: #333;
        --text-secondary: #666;
        --success-color: #107e3e;
        --success-hover: #0d6e36;
        --danger-color: #bb0000;
        --danger-hover: #a30000;
        --warning-color: #e9730c;
        --header-bg: #354a5f;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f7f7f7;
        color: var(--text-color);
      }

      .container {
        width: 95%;
        max-width: 1200px;
        margin: 30px auto;
        padding: 0;
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .header {
        background-color: var(--header-bg);
        color: white;
        padding: 15px 20px;
        border-radius: 8px 8px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h1 {
        font-size: 24px;
        font-weight: 500;
        margin: 0;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-row {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
        flex-wrap: wrap; /* Added for responsiveness */
      }

      .form-col {
        flex: 1;
        min-width: 200px; /* Prevent fields from shrinking too much */
      }

      label {
        display: block;
        margin-bottom: 5px;
        color: var(--text-secondary);
        font-weight: 500;
        font-size: 14px;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 14px;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(8, 84, 160, 0.1);
      }

      textarea {
        resize: vertical;
        min-height: 80px;
      }

      button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: background-color 0.2s;
      }

      .btn-primary {
        background-color: var(--primary-color);
        color: white;
      }

      .btn-primary:hover {
        background-color: var(--primary-hover);
      }

      .btn-success {
        background-color: var(--success-color);
        color: white;
      }

      .btn-success:hover {
        background-color: var(--success-hover);
      }

      .btn-danger {
        background-color: var(--danger-color);
        color: white;
      }

      .btn-danger:hover {
        background-color: var(--danger-hover);
      }

      .btn-secondary {
        background-color: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background-color: #5a6268;
      }

      .requests-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      .requests-table th,
      .requests-table td {
        padding: 12px 15px;
        border: 1px solid var(--border-color);
        text-align: left;
      }

      .requests-table th {
        background-color: var(--secondary-color);
        font-weight: 600;
        color: var(--text-secondary);
      }

      .requests-table tr:hover {
        background-color: #f8f9fa;
      }

      .status-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: bold;
      }

      .action-icon {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 0 2px;
        font-size: 16px;
      }

      .view-icon {
        background-color: #0854a0;
        color: white;
      }
      .print-icon {
        background-color: #6c757d;
        color: white;
      }
      .approve-icon {
        background-color: #28a745;
        color: white;
      }
      .reject-icon {
        background-color: #dc3545;
        color: white;
      }
      .edit-icon {
        background-color: #ffc107;
        color: black;
      }
      .quote-icon {
        background-color: #17a2b8;
        color: white;
      }

      .status-pendente {
        background-color: #ffc107;
        color: black;
      }
      .status-aprovada {
        background-color: #28a745;
        color: white;
      }
      .status-rejeitada {
        background-color: #dc3545;
        color: white;
      }
      .status-cotacao {
        background-color: #17a2b8;
        color: white;
      }

      .filter-row th {
        padding: 5px;
      }

      .filter-input {
        width: 100%;
        padding: 4px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      .sort-header {
        cursor: pointer;
      }

      .sort-header:hover {
        background-color: #f0f0f0;
      }

      .status-container {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .status-indicator {
        font-size: 12px;
      }

      .status-indicator.critical {
        color: #dc3545;
      }

      .status-indicator.warning {
        color: #ffc107;
      }

      .status-indicator.attention {
        color: #17a2b8;
      }

      .status-indicator.normal {
        color: #28a745;
      }

      .status-pendente {
        background-color: #ffc107;
        color: #000;
      }
      .status-aprovada {
        background-color: #28a745;
        color: #fff;
      }
      .status-rejeitada {
        background-color: #dc3545;
        color: #fff;
      }
      .status-cotacao {
        background-color: #17a2b8;
        color: #fff;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }

      .modal-content {
        background-color: white;
        margin: 1% auto;
        padding: 0;
        width: 95%;
        max-width: 1200px;
        border-radius: 8px;
        position: relative;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        max-height: 95vh;
        display: flex;
        flex-direction: column;
        border: 1px solid var(--border-color);
        overflow-y: auto;
      }

      /* Personaliza√ß√£o da barra de rolagem */
      .modal-content::-webkit-scrollbar {
        width: 10px;
      }

      .modal-content::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 5px;
      }

      .modal-content::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 5px;
      }

      .modal-content::-webkit-scrollbar-thumb:hover {
        background: #555;
      }

      .item-descricao {
        min-width: 300px;
        width: 100%;
      }

      .modal-body {
        flex: 1;
        overflow-y: auto;
        padding-bottom: 20px;
      }

      .modal-footer {
        position: sticky;
        bottom: 0;
        background: white;
        padding: 10px;
        display: flex;
        justify-content: flex-end;
        border-top: 1px solid var(--border-color);
        gap: 10px;
      }

      .close-button {
        position: absolute;
        right: 10px;
        top: 10px;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-secondary);
      }

      .items-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }

      .items-table th,
      .items-table td {
        padding: 8px;
        border: 1px solid var(--border-color);
        text-align: left;
      }

      .items-table th {
        background-color: var(--secondary-color);
        font-weight: 600;
        color: var(--text-secondary);
      }

      .history-section {
        margin-top: 20px;
        padding: 15px;
        background-color: var(--secondary-color);
        border-radius: 4px;
        border: 1px solid var(--border-color);
      }

      .history-item {
        padding: 10px;
        border-bottom: 1px solid var(--border-color);
      }

      .history-item:last-child {
        border-bottom: none;
      }

      .edit-warning {
        background-color: #fff3cd;
        color: #856404;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 15px;
        border: 1px solid #ffeeba;
      }

      .access-denied {
        text-align: center;
        padding: 50px 20px;
        background-color: #f8d7da;
        color: #721c24;
        border-radius: 8px;
        margin: 50px auto;
        max-width: 600px;
        border: 1px solid #f5c6cb;
      }

      .error-message {
        background-color: #f8d7da;
        color: #721c24;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 15px;
        display: none;
        border: 1px solid #f5c6cb;
      }

      .conversion-info {
        font-size: 12px;
        color: var(--primary-color);
        margin-top: 5px;
      }

      .required::after {
        content: "*";
        color: var(--danger-color);
        margin-left: 4px;
      }

      .action-buttons {
        display: flex;
        gap: 5px;
      }

      .action-buttons button {
        padding: 5px 10px;
        font-size: 12px;
      }

      .view-button {
        background-color: var(--primary-color);
        color: white;
      }

      .print-button {
        background-color: #6c757d;
        color: white;
      }

      .approve-button {
        background-color: var(--success-color);
        color: white;
      }

      .reject-button {
        background-color: var(--danger-color);
        color: white;
      }

      .edit-button {
        background-color: #ffc107;
        color: #000;
      }

      .create-quotation-button {
        background-color: #17a2b8;
        color: white;
      }
      #linkedItemsModal input[type="search"] {
        margin-bottom: 10px;
        padding: 5px;
      }
      .item-checkbox {
        width: 20px;
        height: 20px;
        margin-right: 5px;
      }
    </style>
  </head>
  <body>
    <div id="mainContainer" class="container">
      <div class="header">
        <h1>Solicita√ß√£o de Compras</h1>
        <div>
          <button
            id="newRequestBtn"
            class="btn-primary"
            onclick="openNewRequestModal()"
          >
            Nova Solicita√ß√£o
          </button>
          <button
            class="btn-secondary"
            onclick="window.location.href='index.html'"
          >
            Voltar
          </button>
        </div>
      </div>

      <table class="requests-table">
        <thead>
          <tr>
            <th class="sort-header" onclick="sortTable('numero')">N√∫mero</th>
            <th class="sort-header" onclick="sortTable('data')">Data</th>
            <th class="sort-header" onclick="sortTable('solicitante')">
              Solicitante
            </th>
            <th class="sort-header" onclick="sortTable('departamento')">
              Departamento
            </th>
            <th class="sort-header" onclick="sortTable('centroCusto')">
              Centro de Custo
            </th>
            <th class="sort-header" onclick="sortTable('itens')">Itens</th>
            <th class="sort-header" onclick="sortTable('prioridade')">
              Prioridade
            </th>
            <th
              class="sort-header"
              onclick="sortTable('status')"
              style="width: 120px"
            >
              Status
            </th>
            <th style="width: 180px; text-align: center">A√ß√µes</th>
          </tr>
          <tr class="filter-row">
            <th>
              <input
                type="text"
                class="filter-input"
                onkeyup="filterTable()"
                data-column="numero"
              />
            </th>
            <th>
              <input
                type="text"
                class="filter-input"
                onkeyup="filterTable()"
                data-column="data"
              />
            </th>
            <th>
              <input
                type="text"
                class="filter-input"
                onkeyup="filterTable()"
                data-column="solicitante"
              />
            </th>
            <th>
              <input
                type="text"
                class="filter-input"
                onkeyup="filterTable()"
                data-column="departamento"
              />
            </th>
            <th>
              <input
                type="text"
                class="filter-input"
                onkeyup="filterTable()"
                data-column="centroCusto"
              />
            </th>
            <th>
              <input
                type="text"
                class="filter-input"
                onkeyup="filterTable()"
                data-column="itens"
              />
            </th>
            <th>
              <input
                type="text"
                class="filter-input"
                onkeyup="filterTable()"
                data-column="prioridade"
              />
            </th>
            <th>
              <input
                type="text"
                class="filter-input"
                onkeyup="filterTable()"
                data-column="status"
              />
            </th>
            <th></th>
          </tr>
        </thead>
        <tbody id="requestsTableBody"></tbody>
      </table>
    </div>

    <div id="accessDenied" class="access-denied" style="display: none">
      <h2>Acesso Negado</h2>
      <p>Voc√™ n√£o possui permiss√£o para acessar esta funcionalidade.</p>
      <p>
        Entre em contato com o administrador do sistema para solicitar acesso.
      </p>
      <button class="btn-secondary" onclick="window.location.href='index.html'">
        Voltar para o Menu
      </button>
    </div>

    <div id="requestModal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeModal('requestModal')">√ó</span>
        <h2 id="modalTitle">Nova Solicita√ß√£o de Compra</h2>
        <div id="displayRequestNumber" style="margin-bottom: 15px"></div>
        <div id="editWarning" class="edit-warning" style="display: none">
          Aten√ß√£o: Esta solicita√ß√£o j√° est√° em processo de cota√ß√£o/aprova√ß√£o. As
          altera√ß√µes ser√£o registradas no hist√≥rico e precisar√£o de nova
          aprova√ß√£o.
        </div>
        <div id="errorMessage" class="error-message"></div>
        <form id="requestForm" onsubmit="handleRequest(event)">
          <input type="hidden" id="editingId" />
          <input type="hidden" id="originalStatus" />

          <div class="form-row">
            <div class="form-col">
              <label>Solicitante:</label>
              <input type="text" id="solicitante" required />
            </div>
            <div class="form-col">
              <label>Departamento:</label>
              <select id="departamento" required>
                <option value="">Selecione...</option>
                <option value="ENGENHARIA">Engenharia</option>
                <option value="PRODUCAO">Produ√ß√£o</option>
                <option value="MANUTENCAO">Manuten√ß√£o</option>
                <option value="QUALIDADE">Qualidade</option>
                <option value="ADMINISTRATIVO">Administrativo</option>
              </select>
            </div>
            <div class="form-col">
              <label>Centro de Custo:</label>
              <select id="centroCusto" required>
                <option value="">Selecione...</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-col">
              <label>Prioridade:</label>
              <select id="prioridade" required>
                <option value="NORMAL">Normal</option>
                <option value="URGENTE">Urgente</option>
                <option value="CRITICA">Cr√≠tica</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>Itens:</label>
            <table class="items-table">
              <thead>
                <tr>
                  <th>C√≥digo</th>
                  <th>Descri√ß√£o</th>
                  <th>Quantidade (PC)</th>
                  <th>Unidade Interna</th>
                  <th>A√ß√µes</th>
                  <th>Quantidade (KG)</th>
                </tr>
              </thead>
              <tbody id="itemsTableBody"></tbody>
            </table>
            <button type="button" class="btn-primary" onclick="addItem()">
              Adicionar Item
            </button>
          </div>

          <div class="form-group">
            <label>Justificativa:</label>
            <textarea id="justificativa" rows="3" required></textarea>
          </div>

          <div class="form-group">
            <label>Motivo da Altera√ß√£o:</label>
            <textarea
              id="motivoAlteracao"
              rows="2"
              style="display: none"
            ></textarea>
          </div>

          <div class="modal-footer">
            <button type="submit" id="submitButton" class="btn-primary">
              Criar Solicita√ß√£o
            </button>
            <button
              type="button"
              id="deleteButton"
              class="btn-danger"
              style="display: none"
              onclick="deleteRequest()"
            >
              Excluir Solicita√ß√£o
            </button>
          </div>
        </form>

        <div id="historySection" class="history-section" style="display: none">
          <h3>Hist√≥rico de Altera√ß√µes</h3>
          <div id="historyContent"></div>
        </div>
      </div>
    </div>

    <!-- Modal para itens vinculados -->
    <div id="linkedItemsModal" class="modal">
      <div class="modal-content" style="max-width: 800px">
        <span class="close-button" onclick="closeModal('linkedItemsModal')"
          >√ó</span
        >
        <h2>Itens Vinculados ao Fornecedor</h2>
        <input
          type="search"
          id="searchLinkedItems"
          oninput="filterLinkedItems(this.value)"
          placeholder="Pesquisar por descri√ß√£o"
        />
        <div style="margin-top: 20px">
          <table class="items-table">
            <thead>
              <tr>
                <th>Selecionar</th>
                <th>C√≥digo</th>
                <th>Descri√ß√£o</th>
                <th>Unidade</th>
                <th>Quantidade</th>
              </tr>
            </thead>
            <tbody id="linkedItemsTableBody"></tbody>
          </table>
          <div style="margin-top: 15px; text-align: right">
            <button
              type="button"
              class="btn-primary"
              onclick="addSelectedItems()"
            >
              Adicionar Itens Selecionados
            </button>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
        import { db } from './firebase-config.js';
      import {
        collection,
        addDoc,
        doc,
        getDoc,
        setDoc,
        runTransaction,
        getDocs,
        updateDoc,
        deleteDoc,
        Timestamp
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      window.printSolicitacao = function(solicitacaoId) {
        window.open(`imprimir_solicitacao.html?solicitacaoId=${solicitacaoId}`, '_blank');
      };

      let produtos = [];
      let solicitacoes = [];
      let ordensProducao = [];
      let estoques = [];
      let fornecedores = [];
      let centrosCusto = [];
      let counterRef;
      let currentUser = null;
      let userPermissions = [];
      let lastQuotationCounter = null; // Cache para contador de cota√ß√µes

      window.onload = async function() {
        try {
          await new Promise(resolve => setTimeout(resolve, 1000)); // Aguarda inicializa√ß√£o completa
          console.log("Verificando autentica√ß√£o...");
          const userSession = localStorage.getItem('currentUser');
          if (!userSession) {
            console.error("Sess√£o n√£o encontrada");
            window.location.href = 'login.html';
            return;
          }
          console.log("Sess√£o encontrada:", userSession);

          if (!userSession) {
            console.log("Nenhuma sess√£o encontrada");
            alert("Usu√°rio n√£o est√° logado. Redirecionando para a p√°gina de login...");
            window.location.href = 'login.html';
            return;
          }

          // Adiciona delay para garantir que os dados foram carregados
          await new Promise(resolve => setTimeout(resolve, 500));

          try {
            currentUser = JSON.parse(userSession);
            console.log("Dados do usu√°rio:", currentUser);

            if (!currentUser || !currentUser.nome) {
              console.log("Dados do usu√°rio inv√°lidos");
              localStorage.removeItem('currentUser');
              window.location.href = 'login.html';
              return;
            }

            console.log("Usu√°rio autenticado:", currentUser.nome);
          } catch (e) {
            console.error("Erro ao processar dados do usu√°rio:", e);
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
            return;
          }

          document.getElementById('mainContainer').style.display = 'block';
          await loadInitialData();
          await loadRequests();
          await checkUserPermissions();

          // Inicializar contador de solicita√ß√µes
          counterRef = doc(db, "contadores", "solicitacoes");
          const counterDoc = await getDoc(counterRef);
          if (!counterDoc.exists()) {
            await setDoc(counterRef, { valor: 0 });
          }

          // Inicializar contador de cota√ß√µes
          const quotationCounterRef = doc(db, "contadores", "cotacoes");
          const quotationCounterDoc = await getDoc(quotationCounterRef);
          if (!quotationCounterDoc.exists()) {
            await setDoc(quotationCounterRef, { valor: 0 });
          } else {
            lastQuotationCounter = quotationCounterDoc.data().valor; // Cache inicial
          }
        } catch (error) {
          console.error("Erro na inicializa√ß√£o:", error);
          alert("Erro ao carregar a aplica√ß√£o");
        }
      };

      async function checkUserPermissions() {
        try {
          if (currentUser.nivel === 5 || currentUser.nivel === 9) {
            document.getElementById('mainContainer').style.display = 'block';
            return;
          }

          const permissionsDoc = await getDoc(doc(db, "permissoes", currentUser.id));
          if (permissionsDoc.exists()) {
            userPermissions = permissionsDoc.data().permissoes || [];
            if (userPermissions.includes('solicitacao_compras')) {
              document.getElementById('mainContainer').style.display = 'block';
              return;
            }
          }

          document.getElementById('accessDenied').style.display = 'block';
        } catch (error) {
          console.error("Erro ao verificar permiss√µes:", error);
          alert("Erro ao verificar permiss√µes.");
        }
      }

      async function generateRequestNumber() {
        try {
          const counterRef = doc(db, "contadores", "solicitacoes");
          const counterDoc = await getDoc(counterRef);

          if (!counterDoc.exists()) {
            await setDoc(counterRef, { valor: 1 });
            return 'SC2504-00001';
          }

          const newValue = counterDoc.data().valor + 1;
          await updateDoc(counterRef, { valor: newValue });

          return `SC2504-${newValue.toString().padStart(5, '0')}`;
        } catch (error) {
          console.error("Erro ao gerar n√∫mero da solicita√ß√£o:", error);
          throw error;
        }
      }

      async function loadInitialData() {
        try {
          console.log("Iniciando carregamento de dados...");

          // Verificar par√¢metros do sistema
          const parametrosDoc = await getDoc(doc(db, "parametros", "sistema"));
          const parametros = parametrosDoc.exists() ? parametrosDoc.data() : {};
          const requireHomologacao = parametros.homologacaoFornecedor || false;


          const [produtosSnap, solicitacoesSnap, ordensSnap, estoquesSnap, fornecedoresSnap, centrosCustoSnap, vinculosSnap] = await Promise.all([
            getDocs(collection(db, "produtos")),
            getDocs(collection(db, "solicitacoesCompra")),
            getDocs(collection(db, "ordensProducao")),
            getDocs(collection(db, "estoques")),
            getDocs(collection(db, "fornecedores")),
            getDocs(collection(db, "centrosCusto")),
            getDocs(collection(db, "produtos_fornecedores"))
          ]);

          produtos = produtosSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          window.produtosFornecedores = vinculosSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          solicitacoes = solicitacoesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          ordensProducao = ordensSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          estoques = estoquesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          fornecedores = fornecedoresSnap.docs
            .map(doc => ({ id: doc.id, ...doc.data() }))
            .filter(f => !requireHomologacao || f.statusHomologacao === 'Homologado');
          centrosCusto = centrosCustoSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

          console.log("Dados carregados:", {
            produtos: produtos.length,
            fornecedores: fornecedores.length,
            centrosCusto: centrosCusto.length
          });

          populateCentrosCusto();
        } catch (error) {
          console.error("Erro ao carregar dados:", error);
          alert("Erro ao carregar dados iniciais.");
        }
      }

      function checkLowStock() {
        try {
          const ordensAtivas = ordensProducao.filter(op =>
            op.status === 'Pendente' || op.status === 'Em Produ√ß√£o'
          );
          alert('Aten√ß√£o: Materiais com estoque baixo identificados. Por favor, verifique a aba de estoque.');
        } catch (error) {
          console.error("Erro ao verificar estoque baixo:", error);
        }
      }

      function populateCentrosCusto() {
        console.log("Populando centros de custo...");
        const select = document.getElementById('centroCusto');
        if (!select) {
          console.error("Elemento 'centroCusto' n√£o encontrado");
          return;
        }

        if (!centrosCusto || !Array.isArray(centrosCusto)) {
          console.error("Dados de centros de custo inv√°lidos:", centrosCusto);
          return;
        }

        select.innerHTML = '<option value="">Selecione...</option>';

        try {
          centrosCusto
            .sort((a, b) => (a.codigo || '').localeCompare(b.codigo || ''))
            .forEach(centro => {
              if (centro && centro.id && centro.codigo) {
                select.innerHTML += `<option value="${centro.id}">${centro.codigo} - ${centro.descricao || ''}</option>`;
              }
            });
          console.log(`${centrosCusto.length} centros de custo carregados`);
        } catch (error) {
          console.error("Erro ao popular centros de custo:", error);
        }
      }

      async function loadRequests() {
        try {
          console.log("Iniciando carregamento das solicita√ß√µes");
          const tableBody = document.getElementById('requestsTableBody');
          if (!tableBody) {
            console.error("Elemento requestsTableBody n√£o encontrado");
            return;
          }
          tableBody.innerHTML = '';

          const [solicitacoesSnap, cotacoesSnap] = await Promise.all([
            getDocs(collection(db, "solicitacoesCompra")),
            getDocs(collection(db, "cotacoes"))
          ]);
          console.log("Solicita√ß√µes encontradas:", solicitacoesSnap.size);

          const cotacoes = cotacoesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          solicitacoes = solicitacoesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

          solicitacoes
            .sort((a, b) => b.dataCriacao.seconds - a.dataCriacao.seconds)
            .forEach(solicitacao => {
              const fornecedor = fornecedores.find(f=> f.id === solicitacao.fornecedorId);
              const centroCusto = centrosCusto.find(cc => cc.id === solicitacao.centroCustoId);
              const hasCotacao = cotacoes.some(c => c.solicitacaoId === solicitacao.id);
              const row = document.createElement('tr');
              row.ondblclick = () => viewRequest(row.querySelector('.view-icon').getAttribute('data-solicitacao-id'));
              row.innerHTML = `
                <td>${solicitacao.numero}</td>
                <td>${new Date(solicitacao.dataCriacao.seconds * 1000).toLocaleDateString()}</td>
                <td>${solicitacao.solicitante}</td>
                <td>${solicitacao.departamento}</td>
                <td>${centroCusto ? centroCusto.codigo + ' - ' + centroCusto.descricao : 'N/A'}</td>
                <td>${solicitacao.itens.length} itens</td>
                <td><span class="status-badge status-${solicitacao.prioridade.toLowerCase()}">${solicitacao.prioridade}</span></td>
                <td>
                  <span class="status-badge status-${solicitacao.status.toLowerCase()}">${solicitacao.status}</span>
                </td>
                <td style="text-align: center;">
                  <div class="action-buttons" style="display: inline-flex; gap: 5px; justify-content: center;">
                    <button class="action-icon view-icon" title="Detalhes" data-solicitacao-id="${solicitacao.id}">üëÅÔ∏è</button>
                    <button class="action-icon print-icon" title="Imprimir" onclick="printSolicitacao('${solicitacao.id}')">üñ®Ô∏è</button>

                  ${
                    solicitacao.status ==='PENDENTE' &&
                    (currentUser.nivel >= 3 || userPermissions.includes('aprovar_solicitacoes'))
                    ? `
                      <button class="action-icon approve-icon" title="Aprovar" data-solicitacao-id="${solicitacao.id}">‚úì</button>
                      <button class="action-icon reject-icon" title="Rejeitar" data-solicitacao-id="${solicitacao.id}">‚úï</button>
                    ` : ''
                  }
                  ${
                    solicitacao.status === 'APROVADA' &&
                    (currentUser.nivel >= 3 || userPermissions.includes('gerar_cotacoes'))
                    ? (
                      hasCotacao
                      ? `<button class="action-icon edit-icon" title="Editar" data-solicitacao-id="${solicitacao.id}">‚úé</button>`
                      : `<button class="action-icon quote-icon" title="Gerar Cota√ß√£o" onclick="selectItemsForQuotation('${solicitacao.id}')">üìù</button>`
                    ) : ''
                  }
                  </div>
                </td>
              `;
              tableBody.appendChild(row);
            });

          addButtonEventListeners();
        } catch (error) {
          console.error("Erro ao carregar solicita√ß√µes:", error);
          alert("Erro ao carregar solicita√ß√µes.");
        }
      }

      function addButtonEventListeners() {
        document.querySelectorAll('.view-button').forEach(button => {
          button.addEventListener('click', () => {
            const solicitacaoId = button.getAttribute('data-solicitacao-id');
            viewRequest(solicitacaoId);
          });
        });

        document.querySelectorAll('.print-button').forEach(button => {
          button.addEventListener('click', () => {      const solicitacaoId = button.getAttribute('data-solicitacao-id');
            window.printSolicitacao(solicitacaoId);
          });
        });

        document.querySelectorAll('.approve-button').forEach(button => {
          button.addEventListener('click', () => {
            const solicitacaoId = button.getAttribute('data-solicitacao-id');
            approveRequest(solicitacaoId);
          });
        });

        document.querySelectorAll('.reject-button').forEach(button => {
          button.addEventListener('click', () => {
            const solicitacaoId = button.getAttribute('data-solicitacao-id');
            rejectRequest(solicitacaoId);
          });
        });

        document.querySelectorAll('.edit-button').forEach(button => {
          button.addEventListener('click', () => {
            const solicitacaoId = button.getAttribute('data-solicitacao-id');
            editRequest(solicitacaoId);
          });
        });

        document.querySelectorAll('.quote-icon').forEach(button => {
          button.addEventListener('click', () => {
            const solicitacaoId = button.getAttribute('data-solicitacao-id');
            selectItemsForQuotation(solicitacaoId);
          });
        });
      }

      window.openNewRequestModal = function() {
        try {
          const userSession = localStorage.getItem('currentUser');
          if (!userSession) {
            alert('Usu√°rio n√£o est√° logado. Por favor, fa√ßa login novamente.');
            window.location.href = 'login.html';
            return;
          }

          currentUser = JSON.parse(userSession);
          if (!currentUser || !currentUser.nome) {
            alert('Sess√£o inv√°lida. Por favor, fa√ßa login novamente.');
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
            return;
          }

          if (currentUser.nivel < 2 && !userPermissions.includes('criar_solicitacoes')) {
            alert('Voc√™ n√£o tem permiss√£o para criar solicita√ß√µes de compra.');
            return;
          }

          const form = document.getElementById('requestForm');
          const modal = document.getElementById('requestModal');
          if (!form || !modal) {
            console.error('Elementos do formul√°rio n√£o encontrados');
            return;
          }

          form.reset();
          document.getElementById('itemsTableBody').innerHTML = '';
          document.getElementById('errorMessage').style.display = 'none';
          document.getElementById('solicitante').value = currentUser.nome;
          document.getElementById('editingId').value = '';
          document.getElementById('originalStatus').value = '';
          document.getElementById('modalTitle').textContent = 'Nova Solicita√ß√£o de Compra';
          document.getElementById('submitButton').textContent = 'Criar Solicita√ß√£o';
          document.getElementById('deleteButton').style.display = 'none';
          document.getElementById('editWarning').style.display = 'none';
          document.getElementById('motivoAlteracao').style.display = 'none';
          document.getElementById('historySection').style.display = 'none';

          populateCentrosCusto();
          populateFornecedores();
          modal.style.display = 'block';
          addItem();
        } catch (error) {
          console.error('Erro ao abrir modal:', error);
          showErrorMessage('Erro ao abrir modal. Por favor, tente novamente.');
        }
      };

      window.closeModal = function(modalId) {
        document.getElementById(modalId).style.display = 'none';
      };

      function populateFornecedores() {
        try {
          const select = document.getElementById('fornecedor');
          if (!select) {
            console.error("Elemento 'fornecedor' n√£o encontrado");
            return;
          }

          select.innerHTML = '<option value="">Selecione...</option>';

          if (!fornecedores || !Array.isArray(fornecedores)) {
            console.error("Dados de fornecedores inv√°lidos:", fornecedores);
            return;
          }

          const fornecedoresHomologados = fornecedores.filter(f => f.statusHomologacao === 'Homologado');
          fornecedoresHomologados.forEach(fornecedor => {
            if (fornecedor && fornecedor.id && fornecedor.razaoSocial) {
              select.innerHTML += `<option value="${fornecedor.id}">${fornecedor.razaoSocial}</option>`;
            }
          });

          if (fornecedoresHomologados.length === 0) {
            console.warn('Nenhum fornecedor homologado dispon√≠vel');
          }
        } catch (error) {
          console.error("Erro ao popular fornecedores:", error);
        }
      }

      function showErrorMessage(message) {
        const errorMessage = document.getElementById('errorMessage');
        if (errorMessage) {
          errorMessage.textContent = message;
          errorMessage.style.display = 'block';
        } else {
          console.error("Elemento 'errorMessage' n√£o encontrado");
          alert(message);
        }
      }

      window.addItem = function() {
        const tableBody = document.getElementById('itemsTableBody');
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <div style="display: flex; gap: 5px;">
              <input type="text" class="item-codigo" placeholder="C√≥digo" style="width: 100px;"
                     onblur="searchProduct(this)" required>
              <button type="button" onclick="openProductSearch(this)">üîç</button>
            </div>
          </td>
          <td><input type="text" class="item-descricao" required readonly></td>
          <td><input type="number" class="item-quantidade" min="0.001" step="0.001" required
                     oninput="updateConversion(this.closest('tr'))"></td>
          <td><span class="item-unidade">PC</span></td>
          <td><button type="button" class="btn-danger" onclick="removeItem(this)">Remover</button></td>
          <td><span class="item-quantidade-kg">-</span></td>
        `;
        tableBody.appendChild(row);
        return row;
      };

      window.searchProduct = function(input) {
        const codigo = input.value.trim().toUpperCase();
        const row = input.closest('tr');
        const descricaoInput = row.querySelector('.item-descricao');
        const unidadeSpan = row.querySelector('.item-unidade');
        const quantidadeKgSpan = row.querySelector('.item-quantidade-kg');

        if (codigo) {
          const produto = produtos.find(p => p.codigo.toUpperCase() === codigo);
          if (produto) {
            if (produto.tipo === 'PA' || produto.tipo === 'SP') {
              alert('N√£o √© poss√≠vel solicitar compra de produtos do tipo PA ou SP.');
              input.value = '';
              descricaoInput.value = '';
              unidadeSpan.textContent = 'PC';
              quantidadeKgSpan.textContent = '-';
              return;
            }

            descricaoInput.value = produto.descricao;
            row.dataset.produtoId = produto.id;
            row.dataset.unidadeInterna = produto.unidade;
            row.dataset.unidadeCompra = produto.unidadeSecundaria || produto.unidade;
            row.dataset.fatorConversao = produto.fatorConversao || 1;

            unidadeSpan.textContent = produto.unidade;
            updateConversion(row);
          } else {
            alert('Produto n√£o encontrado!');
            input.value = '';
            descricaoInput.value = '';
            quantidadeKgSpan.textContent = '-';
          }
        }
      };

      window.updateConversion = function(row) {
        const quantidadeInput = row.querySelector('.item-quantidade');
        const quantidadeKgSpan = row.querySelector('.item-quantidade-kg');
        const fatorConversao = parseFloat(row.dataset.fatorConversao) || 1;
        const unidadeInterna = row.dataset.unidadeInterna;
        const unidadeCompra = row.dataset.unidadeCompra;
        const quantidadePC = parseFloat(quantidadeInput.value) || 0;

        if (quantidadePC > 0 && unidadeInterna === 'PC' && unidadeCompra === 'KG') {
          const quantidadeKG = quantidadePC * fatorConversao;
          quantidadeKgSpan.textContent = `${quantidadeKG.toFixed(3)} KG`;
        } else {
          quantidadeKgSpan.textContent = `${quantidadePC.toFixed(3)} ${unidadeCompra}`;
        }
      };

      window.removeItem = function(button) {
        button.closest('tr').remove();
      };

      window.viewRequest = function(requestId) {
        const solicitacao = solicitacoes.find(s => s.id === requestId);
        if (solicitacao) {
          openRequestModal(solicitacao);
        }
      };

      window.editRequest = function(requestId) {
        const solicitacao = solicitacoes.find(s => s.id === requestId);
        if (solicitacao) {
          openRequestModal(solicitacao);
        }
      };

      function openRequestModal(solicitacao = null) {
        try {
          const modal = document.getElementById('requestModal');
          if (!modal) {
            console.error('Modal element not found');
            return;
          }

          const form = document.getElementById('requestForm');
          const editWarning = document.getElementById('editWarning');
          const motivoAlteracao = document.getElementById('motivoAlteracao');
          const historySection = document.getElementById('historySection');
          const submitButton = document.getElementById('submitButton');
          const deleteButton = document.getElementById('deleteButton');
          const errorMessage = document.getElementById('errorMessage');
          const displayRequestNumber = document.getElementById('displayRequestNumber');
          const itemsTableBody = document.getElementById('itemsTableBody');

          if (!form || !editWarning || !motivoAlteracao || !historySection ||
              !submitButton || !deleteButton || !errorMessage || !displayRequestNumber || !itemsTableBody) {
            console.error('One or more required modal elements not found');
            return;
          }

          form.reset();
          itemsTableBody.innerHTML = '';
          errorMessage.style.display = 'none';
          displayRequestNumber.style.display = 'block';

          if (solicitacao) {
            document.getElementById('modalTitle').textContent = `Editar Solicita√ß√£o`;
            displayRequestNumber.textContent = solicitacao.numero;
            document.getElementById('editingId').value = solicitacao.id;
            document.getElementById('originalStatus').value = solicitacao.status;
            document.getElementById('solicitante').value = solicitacao.solicitante;
            document.getElementById('departamento').value = solicitacao.departamento;
            document.getElementById('centroCusto').value = solicitacao.centroCustoId || '';
            document.getElementById('fornecedor').value = solicitacao.fornecedorId || '';
            document.getElementById('prioridade').value = solicitacao.prioridade;
            document.getElementById('justificativa').value = solicitacao.justificativa;

            solicitacao.itens.forEach(item => {
              const row = addItem();
              row.querySelector('.item-codigo').value = item.codigo;
              row.querySelector('.item-descricao').value = item.descricao;
              row.querySelector('.item-quantidade').value = item.quantidadeInterna;
              const produto = produtos.find(p => p.codigo === item.codigo);
              if (produto) {
                row.dataset.produtoId = produto.id;
                row.dataset.unidadeInterna = produto.unidade;
                row.dataset.unidadeCompra = produto.unidadeSecundaria || produto.unidade;
                row.dataset.fatorConversao = produto.fatorConversao || 1;
                row.querySelector('.item-unidade').textContent = item.unidadeInterna;
                updateConversion(row);
              }
            });

            // Inicialmente esconde o campo de motivo
            editWarning.style.display = 'none';
            motivoAlteracao.style.display = 'none';
            motivoAlteracao.required = false;

            // Adiciona evento para detectar altera√ß√µes no formul√°rio
            const form = document.getElementById('requestForm');
            const initialFormState = JSON.stringify(getFormData());

            form.addEventListener('change', () => {
              const currentFormState = JSON.stringify(getFormData());
              if (solicitacao.status !== 'PENDENTE' && currentFormState !== initialFormState) {
                editWarning.style.display = 'block';
                motivoAlteracao.style.display = 'block';
                motivoAlteracao.required = true;
              } else {
                editWarning.style.display = 'none';
                motivoAlteracao.style.display = 'none';
                motivoAlteracao.required = false;
              }
            });

            function getFormData() {
              return {
                departamento: document.getElementById('departamento').value,
                centroCusto: document.getElementById('centroCusto').value,
                prioridade: document.getElementById('prioridade').value,
                justificativa: document.getElementById('justificativa').value,
                itens: Array.from(document.querySelectorAll('#itemsTableBody tr')).map(row => ({
                  codigo: row.querySelector('.item-codigo').value,
                  quantidade: row.querySelector('.item-quantidade').value
                }))
              };
            }

            if (solicitacao.historico && solicitacao.historico.length > 0) {
              historySection.style.display = 'block';
              const historyContent = document.getElementById('historyContent');
              historyContent.innerHTML = solicitacao.historico.map(h => `
                <div class="history-item">
                  <strong>Data:</strong> ${new Date(h.data.seconds * 1000).toLocaleString()}<br>
                  <strong>Status Anterior:</strong> ${h.statusAnterior}<br>
                  <strong>Motivo:</strong> ${h.motivo}
                </div>
              `).join('');
            } else {
              historySection.style.display = 'none';
            }

            const canEdit = currentUser.nivel >= 2 ||
                           userPermissions.includes('editar_solicitacoes') ||
                           solicitacao.solicitante === currentUser.nome;

            if (!canEdit) {
              document.querySelectorAll('#requestForm input, #requestForm select, #requestForm textarea').forEach(el => {
                el.disabled = true;
              });
              submitButton.style.display = 'none';
              deleteButton.style.display = 'none';
            } else {
              submitButton.textContent = 'Atualizar Solicita√ß√£o';
              deleteButton.style.display = 'block';
              deleteButton.dataset.requestId = solicitacao.id;
            }
          } else {
            document.getElementById('modalTitle').textContent = 'Nova Solicita√ß√£o de Compra';
            displayRequestNumber.textContent = 'Ser√° gerado automaticamente';
            document.getElementById('editingId').value = '';
            document.getElementById('originalStatus').value = '';
            document.getElementById('solicitante').value = currentUser.nome;
            editWarning.style.display = 'none';
            motivoAlteracao.style.display = 'none';
            motivoAlteracao.required = false;
            historySection.style.display = 'none';
            submitButton.textContent = 'Criar Solicita√ß√£o';
            deleteButton.style.display = 'none';
            populateFornecedores();
            populateCentrosCusto();
            addItem();
          }

          modal.style.display = 'block';
        } catch (error) {
          console.error('Erro ao abrir modal:', error);
          showErrorMessage('Erro ao abrir modal. Por favor, tente novamente.');
        }
      }

      window.handleRequest = async function(event) {
        event.preventDefault();

        const editingId = document.getElementById('editingId').value;
        if (editingId) {
          const solicitacao = solicitacoes.find(s => s.id === editingId);
          const canEdit = currentUser.nivel >= 2 ||
                         userPermissions.includes('editar_solicitacoes') ||
                         solicitacao.solicitante === currentUser.nome;
          if (!canEdit) {
            alert('Voc√™ n√£o tem permiss√£o para editar esta solicita√ß√£o.');
            return;
          }
        } else {
          if (currentUser.nivel < 2 && !userPermissions.includes('criar_solicitacoes')) {
            alert('Voc√™ n√£o tem permiss√£o para criar solicita√ß√µes de compra.');
            return;
          }
        }

        const codigosItens = new Set();
        let hasDuplicates = false;
        let hasInvalidProductType = false;

        document.querySelectorAll('#itemsTableBody tr').forEach(row => {
          const codigo = row.querySelector('.item-codigo').value;
          if (codigosItens.has(codigo)) {
            hasDuplicates = true;
          }
          codigosItens.add(codigo);

          const produto = produtos.find(p => p.codigo === codigo);
          if (produto && (produto.tipo === 'PA' || produto.tipo === 'SP')) {
            hasInvalidProductType = true;
          }
        });

        const errorMessage = document.getElementById('errorMessage');

        if (hasDuplicates) {
          showErrorMessage('N√£o √© permitido incluir o mesmo item mais de uma vez.');
          return;
        }

        if (hasInvalidProductType) {
          showErrorMessage('N√£o √© poss√≠vel solicitar compra de produtos do tipo PA ou SP.');
          return;
        }

        const centroCustoId = document.getElementById('centroCusto').value;
        if (!centroCustoId) {
          showErrorMessage('Selecione um centro de custo.');
          return;
        }

        // Validar or√ßamento do centro de custo
        const centroCusto = centrosCusto.find(cc => cc.id === centroCustoId);
        if (!centroCusto) {
          showErrorMessage('Centro de custo n√£o encontrado.');
          return;
        }

        // Calcular valor total da solicita√ß√£o
        let valorTotalSolicitacao = 0;
        document.querySelectorAll('#itemsTableBody tr').forEach(row => {
          const quantidade = parseFloat(row.querySelector('.item-quantidade').value);
          const produto = produtos.find(p => p.codigo === row.querySelector('.item-codigo').value);
          if (produto && produto.precoMedio) {
            valorTotalSolicitacao += quantidade * produto.precoMedio;
          }
        });

        // Buscar total j√° utilizado no m√™s
        const inicioMes = new Date();
        inicioMes.setDate(1);
        inicioMes.setHours(0, 0, 0, 0);

        const solicitacoesDoMes = solicitacoes.filter(s =>
          s.centroCustoId === centroCustoId &&
          s.dataCriacao.seconds >= inicioMes.getTime() / 1000 &&
          s.status !== 'REJEITADA'
        );

        const valorUtilizado = solicitacoesDoMes.reduce((total, s) => total + (s.valorTotal || 0), 0);
        const limiteDisponivel = (centroCusto.orcamentoMensal || 0) - valorUtilizado;

        if (valorTotalSolicitacao > limiteDisponivel) {
          if (!confirm(`Aten√ß√£o: Esta solicita√ß√£o exceder√° o or√ßamento mensal do centro de custo!\n\nOr√ßamento Mensal: R$ ${centroCusto.orcamentoMensal?.toFixed(2)}\nJ√° Utilizado: R$ ${valorUtilizado.toFixed(2)}\nDispon√≠vel: R$ ${limiteDisponivel.toFixed(2)}\nValor Solicita√ß√£o: R$ ${valorTotalSolicitacao.toFixed(2)}\n\nDeseja continuar mesmo assim?`)) {
            return;
          }
        }

        const fornecedorId = document.getElementById('fornecedor').value;
        if (!fornecedorId) {
          showErrorMessage('Selecione um fornecedor homologado.');
          return;
        }

        const items = [];
        document.querySelectorAll('#itemsTableBody tr').forEach(row => {
          const quantidadeInterna = parseFloat(row.querySelector('.item-quantidade').value);
          const fatorConversao = parseFloat(row.dataset.fatorConversao) || 1;
          const unidadeInterna = row.dataset.unidadeInterna;
          const unidadeCompra = row.dataset.unidadeCompra;
          const quantidadeCompra = unidadeInterna === 'PC' && unidadeCompra === 'KG'
            ? quantidadeInterna * fatorConversao
            : quantidadeInterna;

          items.push({
            codigo: row.querySelector('.item-codigo').value,
            descricao: row.querySelector('.item-descricao').value,
            quantidadeInterna: quantidadeInterna,
            quantidadeCompra: quantidadeCompra,
            unidadeInterna: unidadeInterna,
            unidadeCompra: unidadeCompra,
            fatorConversao: fatorConversao
          });
        });

        if (items.length === 0) {
          showErrorMessage('Adicione pelo menos um item √† solicita√ß√£o.');
          return;
        }

        try {
          const solicitacaoData = {
            solicitante: document.getElementById('solicitante').value,
            departamento: document.getElementById('departamento').value,
            centroCustoId,
            fornecedorId,
            prioridade: document.getElementById('prioridade').value,
            itens: items,
            justificativa: document.getElementById('justificativa').value,
            valorTotal: valorTotalSolicitacao
          };

          if (editingId) {
            const originalStatus = document.getElementById('originalStatus').value;
            const motivoAlteracao = document.getElementById('motivoAlteracao').value;
            if (originalStatus !== 'PENDENTE') {
              solicitacaoData.status = 'PENDENTE';
              const solicitacao = solicitacoes.find(s => s.id === editingId);
              const historicoItem = {
                data: Timestamp.now(),
                statusAnterior: originalStatus,
                motivo: motivoAlteracao
              };
              solicitacaoData.historico = [
                ...(solicitacao.historico || []),
                historicoItem
              ];
            }
            await updateDoc(doc(db, "solicitacoesCompra", editingId), solicitacaoData);
            alert('Solicita√ß√£o atualizada com sucesso!');
          } else {
            solicitacaoData.numero = await generateRequestNumber();
            solicitacaoData.status = 'PENDENTE';
            solicitacaoData.dataCriacao = Timestamp.now();
            await addDoc(collection(db, "solicitacoesCompra"), solicitacaoData);
            alert('Solicita√ß√£o criada com sucesso!');
          }

          closeModal('requestModal');
          await loadInitialData();
          await loadRequests();
        } catch (error) {
          console.error("Erro ao salvar solicita√ß√£o:", error);
          showErrorMessage("Erro ao salvar solicita√ß√£o.");
        }
      };

      window.approveRequest = async function(requestId) {
        if (currentUser.nivel < 3 && !userPermissions.includes('aprovar_solicitacoes')) {
          alert('Voc√™ n√£o tem permiss√£o para aprovar solicita√ß√µes.');
          return;
        }

        if (confirm('Confirma a aprova√ß√£o desta solicita√ß√£o?')) {
          try {
            await updateDoc(doc(db, "solicitacoesCompra", requestId), {
              status: 'APROVADA',
              dataAprovacao: Timestamp.now(),
              aprovadoPor: currentUser.nome
            });
            await loadInitialData();
            await loadRequests();
            alert('Solicita√ß√£o aprovada com sucesso!');
          } catch (error) {
            console.error("Erro ao aprovar solicita√ß√£o:", error);
            showErrorMessage("Erro ao aprovar solicita√ß√£o.");
          }
        }
      };

      window.rejectRequest = async function(requestId) {
        if (currentUser.nivel < 3 && !userPermissions.includes('aprovar_solicitacoes')) {
          alert('Voc√™ n√£o tem permiss√£o para rejeitar solicita√ß√µes.');
          return;
        }

        const motivo = prompt('Informe o motivo da rejei√ß√£o:');
        if (motivo) {
          try {
            await updateDoc(doc(db, "solicitacoesCompra", requestId), {
              status: 'REJEITADA',
              dataRejeicao: Timestamp.now(),
              rejeitadoPor: currentUser.nome,
              motivoRejeicao: motivo
            });
            await loadInitialData();
            await loadRequests();
            alert('Solicita√ß√£o rejeitada com sucesso!');
          } catch (error) {
            console.error("Erro ao rejeitar solicita√ß√£o:", error);
            showErrorMessage("Erro ao rejeitar solicita√ß√£o.");
          }
        }
      };

      window.selectItemsForQuotation = async function(requestId) {
        const button = document.querySelector(`.quote-icon[data-solicitacao-id="${requestId}"]`);
        if (!button) {
          console.error('Bot√£o n√£o encontrado para solicita√ß√£o:', requestId);
          return;
        }
        button.disabled = true;
        button.textContent = 'Processando...';

        try {
          const solicitacao = solicitacoes.find(s => s.id === requestId);
          if (!solicitacao) {
            throw new Error('Solicita√ß√£o n√£o encontrada');
          }

          const modal = createSelectItemsModal(solicitacao);
          modal.style.display = 'block';

        } catch (error) {
          console.error('Erro ao gerar cota√ß√£o:', error);
          showErrorMessage(`Erro ao gerar cota√ß√£o: ${error.message}`);
        } finally {
          button.disabled = false;
          button.textContent = 'Gerar Cota√ß√£o';
        }
      };

      function createSelectItemsModal(solicitacao) {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'selectItemsModal';

        const content = document.createElement('div');
        content.className = 'modal-content';

        const closeButton = document.createElement('span');
        closeButton.className = 'close-button';
        closeButton.textContent = '√ó';
        closeButton.onclick = () => {
          modal.style.display = 'none';
        };
        content.appendChild(closeButton);

        const title = document.createElement('h2');
        title.textContent = 'Selecione Itens para Cota√ß√£o';
        content.appendChild(title);

        const itemsContainer = document.createElement('div');
        solicitacao.itens.forEach(item => {
          const itemDiv = document.createElement('div');
          itemDiv.innerHTML = `
            <input type="checkbox" class="item-checkbox" id="item-${item.codigo}" value="${item.codigo}" checked>
            <label for="item-${item.codigo}">${item.descricao}</label>
          `;
          itemsContainer.appendChild(itemDiv);
        });
        content.appendChild(itemsContainer);

        const footer = document.createElement('div');
        footer.className = 'modal-footer';

        const generateButton = document.createElement('button');
        generateButton.className = 'btn-primary';
        generateButton.textContent = 'Gerar Cota√ß√£o';
        generateButton.onclick = async () => {
          const selectedItems = [];
          const checkboxes = document.querySelectorAll('.item-checkbox');
          checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
              selectedItems.push(checkbox.value);
            }
          });

          if (selectedItems.length === 0) {
            alert('Selecione pelo menos um item.');
            return;
          }

          await createQuotation(solicitacao.id, selectedItems);
          modal.style.display = 'none';
        }
        footer.appendChild(generateButton);

        const cancelButton = document.createElement('button');
        cancelButton.className = 'btn-secondary';
        cancelButton.textContent = 'Cancelar';
        cancelButton.onclick = () => {
          modal.style.display = 'none';
        };
        footer.appendChild(cancelButton);

        content.appendChild(footer);
        modal.appendChild(content);
        document.body.appendChild(modal);
        return modal;
      }

        async function createQuotation(requestId, selectedItems) {
          const button = document.querySelector(`.quote-icon[data-solicitacao-id="${requestId}"]`);
          if (!button) {
            console.error('Bot√£o n√£o encontrado para solicita√ß√£o:', requestId);
            return;
          }

          button.disabled = true;
          button.textContent = 'Processando...';

          try {
            const solicitacao = solicitacoes.find(s => s.id === requestId);
            if (!solicitacao) {
              throw new Error('Solicita√ß√£o n√£o encontrada');
            }

            const cotacaoData = {
              numero: await generateQuotationNumber(),
              solicitacaoId: requestId,
              centroCustoId: solicitacao.centroCustoId,
              fornecedorId: solicitacao.fornecedorId,
              itens: solicitacao.itens.filter(item => selectedItems.includes(item.codigo)).map(item => ({
                codigo: item.codigo,
                descricao: item.descricao,
                quantidade: item.quantidadeCompra,
                unidade: item.unidadeCompra
              })),
              status: 'PENDENTE',
              dataCriacao: Timestamp.now(),
              criadoPor: currentUser.nome
            };

            await addDoc(collection(db, 'cotacoes'), cotacaoData);
            await updateDoc(doc(db, 'solicitacoesCompra', requestId), {
              status: 'COTACAO',
              geradoPor: currentUser.nome
            });

            alert('Cota√ß√£o gerada com sucesso!');
            await loadInitialData();
            await loadRequests();
            return true;
          } catch (error) {
            console.error('Erro ao gerar cota√ß√£o:', error);
            showErrorMessage(`Erro ao gerar cota√ß√£o: ${error.message}`);
            return false;
          } finally {
            if (button) {
              button.disabled = false;
              button.textContent = 'Criar Cota√ß√£o';
            }
          }
        }

        async function generateQuotationNumber() {
          const date = new Date();
          const year = date.getFullYear().toString().substr(-2);
          const month = (date.getMonth() + 1).toString().padStart(2, '0');
          const docRef = doc(collection(db, 'cotacoes')); // Cria refer√™ncia para novo documento
          const docId = docRef.id; // Obt√©m ID autom√°tico
          const sequence = docId.slice(0, 6); // Usa primeiros 6 caracteres do ID
          const numero = `CT${year}${month}${sequence}`;
          console.log(`N√∫mero da cota√ß√£o gerado: ${numero}`);
          return numero;
        }
        window.deleteRequest = async function() {
          const requestId = document.getElementById('deleteButton').dataset.requestId;
          if (!requestId) return;

          try {
            // Check for related quotes
            const quotesSnapshot = await getDocs(collection(db, "cotacoes"));
            const relatedQuotes = quotesSnapshot.docs.filter(doc => doc.data().solicitacaoId === requestId);

            if (relatedQuotes.length > 0) {
              if (confirm(`Esta solicita√ß√£o possui ${relatedQuotes.length} cota√ß√£o(√µes). Deseja excluir as cota√ß√µes e a solicita√ß√£o?`)) {
                // Delete all related quotes first
                for (const quote of relatedQuotes) {
                  await deleteDoc(doc(db, "cotacoes", quote.id));
                }
              } else {
                return;
              }
            }

            // Then delete the request
            if (confirm('Confirma a exclus√£o desta solicita√ß√£o? Esta a√ß√£o n√£o pode ser desfeita.')) {
              await deleteDoc(doc(db, "solictacoesCompra", requestId));
              alert('Solicita√ß√£o e cota√ß√µes relacionadas foram exclu√≠das com sucesso!');
              closeModal('requestModal');
              await loadInitialData();
              await loadRequests();
            }
          } catch (error) {
            console.error("Erro ao excluir solicita√ß√£o:", error);
            showErrorMessage("Erro ao excluir solicita√ß√£o: " + error.message);
          }
        };

        window.updateLinkedItemsButton = function() {
          const fornecedorId = document.getElementById('fornecedor').value;
          const viewLinkedItemsBtn = document.getElementById('viewLinkedItemsBtn');
          viewLinkedItemsBtn.style.display = fornecedorId ? 'block' : 'none';
        };

        window.filterLinkedItems = function(searchText) {
          const rows = document.querySelectorAll('#linkedItemsTableBody tr');
          const search = searchText.toLowerCase();

          rows.forEach(row => {
            const descricao = row.children[2].textContent.toLowerCase();
            row.style.display = descricao.includes(search) ? '' : 'none';
          });
        };

        window.viewLinkedItems = function() {
          const fornecedorId = document.getElementById('fornecedor').value;
          const tableBody = document.getElementById('linkedItemsTableBody');
          tableBody.innerHTML = '';

          produtos.forEach(produto => {
            const vinculo = window.produtosFornecedores.find(v => v.produtoId === produto.id && v.fornecedorId === fornecedorId);
            if (vinculo) {
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>
                  <input type="checkbox" class="item-select" data-codigo="${produto.codigo}">
                </td>
                <td>${produto.codigo}</td>
                <td>${produto.descricao}</td>
                <td>${produto.unidade}</td>
                <td>
                  <input type="number" class="item-qty" min="0.001" step="0.001" style="width: 100px;">
                </td>
              `;
              tableBody.appendChild(row);
            }
          });

          document.getElementById('linkedItemsModal').style.display = 'block';
        };

        window.addSelectedItems = function() {
          const selectedRows = document.querySelectorAll('#linkedItemsTableBody tr');
          let itemsAdded = 0;

          selectedRows.forEach(row => {
            const checkbox = row.querySelector('.item-select');
            const quantidade = row.querySelector('.item-qty').value;

            if (checkbox.checked && quantidade > 0) {
              const codigo = checkbox.dataset.codigo;
              const newRow = addItem();
              const codigoInput = newRow.querySelector('.item-codigo');
              codigoInput.value = codigo;
              searchProduct(codigoInput);
              newRow.querySelector('.item-quantidade').value = quantidade;
              updateConversion(newRow);
              itemsAdded++;
            }
          });

          if (itemsAdded > 0) {
            closeModal('linkedItemsModal');
          } else {
            alert('Selecione pelo menos um item e informe a quantidade.');
          }
        };

        window.openProductSearch = function(button) {
          const row = button.closest('tr');
          const codigoInput = row.querySelector('.item-codigo');
          const codigo = prompt('Digite o c√≥digo do produto:');
          if (codigo) {
            codigoInput.value = codigo;
            searchProduct(codigoInput);
          }
        };

        function getStatusClass(solicitacao) {
          const now = Date.now() / 1000;
          const dataCriacao = solicitacao.dataCriacao.seconds;
          const prazo = solicitacao.prazoDias || 7;
          const dataLimite = dataCriacao + prazo * 86400;

          if (solicitacao.status === 'PENDENTE' && now > dataLimite) {
            return 'status-critical';
          } else if (solicitacao.status === 'PENDENTE' && now + 86400 > dataLimite) {
            return 'status-warning';
          } else {
            return 'status-normal';
          }
        }
        window.filterTable = function() {
            const rows = document.querySelectorAll('#requestsTableBody tr');
            const filters = {};

            document.querySelectorAll('.filter-input').forEach(input => {
              filters[input.dataset.column] = input.value.toLowerCase();
            });

            rows.forEach(row => {
              let show = true;
              const cells = row.getElementsByTagName('td');

              Object.keys(filters).forEach((column, index) => {
                const cellText = cells[index].textContent.toLowerCase();
                if (filters[column] && !cellText.includes(filters[column])) {
                  show = false;
                }
              });

              row.style.display = show ? '' : 'none';
            });
          };

          let currentSort = { column: '', direction: 'asc' };

          window.sortTable = function(column) {
            const tbody = document.getElementById('requestsTableBody');
            const rows = Array.from(tbody.getElementsByTagName('tr'));

            if (currentSort.column === column) {
              currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
              currentSort = { column, direction: 'asc' };
            }

            rows.sort((a, b) => {
              let aValue = a.cells[getColumnIndex(column)].textContent;
              let bValue = b.cells[getColumnIndex(column)].textContent;

              if (column === 'data') {
                aValue = new Date(aValue);
                bValue = new Date(bValue);
              }

              if (aValue < bValue) return currentSort.direction === 'asc' ? -1 : 1;
              if (aValue > bValue) return currentSort.direction === 'asc' ? 1 : -1;
              return 0;
            });

            rows.forEach(row => tbody.appendChild(row));
          };

          function getColumnIndex(column) {
            const columns = {
              'numero': 0,
              'data': 1,
              'solicitante': 2,
              'departamento': 3,
              'centroCusto': 4,
              'fornecedor': 5,
              'itens': 6,
              'prioridade': 7,
              'status': 8
            };
            return columns[column] || 0;
          }
    </script>
  </body>
</html>